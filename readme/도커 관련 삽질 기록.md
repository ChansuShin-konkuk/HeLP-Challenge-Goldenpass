# 도커 관련 삽질 기록

## 19.01.31 목요일

* 태우님 자료를 통해 도커 설치와 드라이브 설정까지 마친 상태
* `docker pull tensorflow/tensorflow:1.12.0-devel-gpu-py3` 로 tensorflow 설치

```bash
~$ PS C:\Windows\system32> docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
~$ PS C:\Windows\system32> docker pull tensorflow/tensorflow:1.12.0-devel-gpu-py3
1.12.0-devel-gpu-py3: Pulling from tensorflow/tensorflow
18d680d61657: Pull complete
0addb6fece63: Pull complete
78e58219b215: Pull complete
eb6959a66df2: Pull complete
e3eb30fe4844: Pull complete
852c9b7a4425: Pull complete
0a298bf31111: Pull complete
a89ee25b70fc: Pull complete
c272e2cb0801: Pull complete
ea252ba76a44: Pull complete
da4cc4e11c5d: Pull complete
2408727e8c47: Pull complete
d192f3704689: Pull complete
daf16357b0cd: Pull complete
8c2f15015b25: Pull complete
922d92f24484: Pull complete
df5ac730b629: Pull complete
78edd06d3475: Pull complete
f1896b9de9fe: Pull complete
b88d38869a7f: Pull complete
7d8961fdd3b3: Pull complete
Digest: sha256:c5337ac6d05906b1093fddb6cafc9894f109dcc6f39cb1b725d4ec018fc6dc75
Status: Downloaded newer image for tensorflow/tensorflow:1.12.0-devel-gpu-py3
~$ PS C:\Windows\system32> docker images
REPOSITORY              TAG                    IMAGE ID            CREATED             SIZE
tensorflow/tensorflow   1.12.0-devel-gpu-py3   d6c139d2fdbf        2 months ago        3.77GB
```

* 다운은 받았는데 어떻게 실행시키지...

```bash
~$ PS C:\Windows\system32> docker run d6c
~$ PS C:\Windows\system32> docker run d6c /bin/bash
~$ PS C:\Windows\system32> docker run --rm -i -t tensorflow /bin/bash
Unable to find image 'tensorflow:latest' locally
C:\Program Files\Docker\Docker\Resources\bin\docker.exe: Error response from daemon: pull access denied for tensorflow, repository does not exist or may require 'docker login'.
See 'C:\Program Files\Docker\Docker\Resources\bin\docker.exe run --help'.
```

```bash
~$ PS C:\Windows\system32> docker run --rm -i -t tensorflow/tensorflow /bin/bash
Unable to find image 'tensorflow/tensorflow:latest' locally
latest: Pulling from tensorflow/tensorflow
18d680d61657: Already exists
0addb6fece63: Already exists
78e58219b215: Already exists
eb6959a66df2: Already exists
4263945a5710: Pull complete
282d99d903f2: Pull complete
dd620fc3ae28: Pull complete
aa8e48babf4b: Pull complete
27c088fb1ccc: Pull complete
ca88730530b5: Pull complete
5f530f9c7fc4: Pull complete
8ea52f77069e: Pull complete
Digest: sha256:ce5416e416bac281e600fa0bf3aac250514287ed31055d0d06742a4e8332dc89
Status: Downloaded newer image for tensorflow/tensorflow:latest
root@9315512c291e:/notebooks# exit
exit
```

* 실수로 최신 버전을 설치 한 것 같다. 지우고 태그 붙여서 실행해보자.

```bash
~$ PS C:\Windows\system32> docker rmi tensorflow/tensorflow:latest
Untagged: tensorflow/tensorflow:latest
Untagged: tensorflow/tensorflow@sha256:ce5416e416bac281e600fa0bf3aac250514287ed31055d0d06742a4e8332dc89
Deleted: sha256:2054925f3b43b912c05c4b0d0b8f974f2caaa366786e0f7c31e149cd51327898
Deleted: sha256:11c26d5a2531149eb3ef850ad2691d1946f5ab55a24b568d32fda1ac6dbfbad0
Deleted: sha256:3197d60fdb42c348b5e323d9daef53c9c78922182919c51b974cc2e0403eaae7
Deleted: sha256:aef8e3b280db30edfc6d158b7c6518b1efdcb0b4ffe17835e381acde5b061689
Deleted: sha256:25ab0ebca42b004bd92a0eb288ccc5d825b5a116378984502a0db5f186d16bfc
Deleted: sha256:9f56e237bfadf421d465a301e65f253696c6e4e51e2bdcbafb89322fcc4c0113
Deleted: sha256:9bd049f281764ac591837cb2c7411fc9189a8fbe88c1bbca93ce534fa356414b
Deleted: sha256:6dbf6ead204afa6659b4692f0c1567ae5d3cbb5ebea5d3209895d98a297b3531
Deleted: sha256:3be2835a9f2bb267330f731bf94afa084353571703d70e871365fc2524b19f86
~$ PS C:\Windows\system32> docker run --rm -i -t tensorflow/tensorflow:1.12.0-devel-gpu-py3 /bin/bash
root@b36ac5aa9004:~#
```

* 오오 성공!! 이제 파이썬 파일이랑 이것저것 해서 컨테이너를 만들어야 하는건가?

---

### 19.02.01 금요일

* 여러 삽질을 경험한 끝에 어제했던 것은 정말 삽질이었고(주륵), Dockerfile을 통해서 image를 만들어야 한다는 것을 알았다.(도커 초짜의 한계ㅠㅠ)
* `D:\Docker\HeLP` 경로에 Dockerfile 및 여러가지 넣기 (by 태우님).

```bash
└- HeLP
	|- Dockerfile
	|- inference.py
	|- inference.sh
	|- requirements.txt
	|- train.py
	└- train.sh
```

* Dockerfile은 다음과 같다.

```dockerfile
# Use an official Python runtime as a parent image
FROM ubuntu:16.04

# Set the working directory to /app
WORKDIR /

# Copy the current directory contents into the container at /app
COPY . .

# Update
RUN apt-get update
RUN apt-get install -y software-properties-common
RUN add-apt-repository ppa:jonathonf/python-3.6

RUN apt-get update


RUN apt-get install -y build-essential python3.6 python3.6-dev python3-pip python3.6-venv
RUN apt-get install -y autoconf \
											automake \
											cmake \
											git \
											libgtk2.0-dev \
											libjpeg-dev \
											liblcms2-dev \
											libpng-dev \
											libsqlite3-dev \
											libtiff-dev \
											libtool \
											libxml2-dev \
											pkg-config \
											python-pip \
											sqlite3 \
											wget
RUN git clone https://github.com/uclouvain/openjpeg.git 
RUN cd openjpeg && mkdir build && cd build && cmake ../ -DCMAKE_BUILD_TYPE=Release && make && make install && make clean 

RUN git clone https://github.com/openslide/openslide.git
RUN cd openslide && autoreconf -i && ./configure && make && make install 

RUN wget https://github.com/openslide/openslide/releases/download/v3.4.1/openslide-3.4.1.tar.gz
RUN tar xvzf openslide-3.4.1.tar.gz 
RUN cd openslide-3.4.1 && ./configure && make && make install && cd /



RUN python3.6 -m pip install pip --upgrade

# Install any needed packages specified in requirements.txt
RUN python3.6 -m pip install -r ./requirements.txt
ENV LD_LIBRARY_PATH /usr/local/lib
```

* Dockerfile이 있는 위치로 이동 후 [여기](http://pyrasis.com/book/DockerForTheReallyImpatient/Chapter04/03)에 나와있는 방법대로 이미지 빌드하기.
* Dockerfile에 `VOLUME ["/data"]` 와 같이 호스트와 파일 공유를 할 수 있다고 하는데, 일단 그냥 빌드해보자.
* 받아야 할게 많다보니 생각보다 오래걸린다.
* 로그가 상당히 기니깐 일부 생략하겠다.

```bash
~$ PS C:\Windows\system32> cd D:\Docker\HeLP
~$ PS D:\Docker\HeLP> docker build --tag test:0.1 .
Sending build context to Docker daemon  8.192kB
Step 1/19 : FROM ubuntu:16.04
16.04: Pulling from library/ubuntu
7b722c1070cd: Pull complete
5fbf74db61f1: Pull complete
ed41cb72e5c9: Pull complete
7ea47a67709e: Pull complete
Digest: sha256:e4a134999bea4abb4a27bc437e6118fdddfb172e1b9d683129b74d254af51675
Status: Downloaded newer image for ubuntu:16.04
 ---> 7e87e2b3bf7a
Step 2/19 : WORKDIR /
 ---> Running in 59c4792fc6ab
Removing intermediate container 59c4792fc6ab
 ---> de44c73e9f85
Step 3/19 : COPY . .
 ---> 3669e973c7fe
Step 4/19 : RUN apt-get update

#########################################중략#########################################

Step 19/19 : ENV LD_LIBRARY_PATH /usr/local/lib
 ---> Running in ecd43b1fbeec
Removing intermediate container ecd43b1fbeec
 ---> 8337e8b1f269
Successfully built 8337e8b1f269
Successfully tagged test:0.1
SECURITY WARNING: You are building a Docker image from Windows against a non-Windows Docker host. All files and directories added to build context will have '-rwxr-xr-x' permissions. It is recommended to double check and reset permissions for sensitive files and directories.
~$ PS D:\Docker\HeLP>
```

* 설치 완료! 그럼 이미지를 확인해보자.

```bash
~$ PS D:\Docker\HeLP> docker images
REPOSITORY                 TAG                    IMAGE ID            CREATED             SIZE
test                       0.1                    8337e8b1f269        18 minutes ago      1.44GB
ubuntu                     16.04                  7e87e2b3bf7a        9 days ago          117MB
tensorflow/tensorflow      1.12.0-devel-gpu-py3   d6c139d2fdbf        2 months ago        3.77GB
docker4w/nsenter-dockerd   latest                 2f1c802f322f        3 months ago        187kB
```

* `ubuntu` 와 `test`가 생겼다. 이제 실행을 시켜보자.

```bash
~$ PS D:\Docker\HeLP> docker run -i -t --name test_container test:0.1 /bin/bash
$ root@8e979da535b5:/# ls
Dockerfile  boot  etc   inference.py  lib    media  openjpeg   openslide-3.4.1         opt   requirements.txt  run   srv  tmp       train.sh  var
bin         dev   home  inference.sh  lib64  mnt    openslide  openslide-3.4.1.tar.gz  proc  root              sbin  sys  train.py  usr
$ root@8e979da535b5:/#
```

* `-i`(interactive)와 `-t`(pesudo-tty)를 사용하면 bash를 통해서 출력 가능
* 따로 `VOLUME`설정을 하지 않아도 dockerfile와 같은 디렉토리에 있는(`docker build` 명령어를 실행한 위치의) 파일들은 자동으로 올라가는 것 같다.

* `train.py`를 확인하기 위해 vim으로 열어보자.(vim 설치가 3분 정도 걸린다. 다운 속도 13kb/s 무엇?)

```bash
$ root@8e979da535b5:/# apt-get install vim
Reading package lists... Done
Building dependency tree
Reading state information... Done

#########################################중략#########################################

update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/ex (ex) in auto mode
update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/editor (editor) in auto mode
Processing triggers for libc-bin (2.23-0ubuntu10) ...
$ root@8e979da535b5:/# vi train.py
```

* 제대로 업로드 된 것 같다. 근데 컨테이너의 파일과 디렉토리랑 연동이 되면 참 좋을텐데....
  일단 그건 나중에 다시 생각해보고 일단 이미지 빌드해서 카브에 업로드까지 해보자.
* 이미지를 빌드하기 전에 `train.sh`와 `inference.sh`의 권한을 변경해야 한다.(실행 권한 추가; [여기](https://zetawiki.com/wiki/%EB%A6%AC%EB%88%85%EC%8A%A4_chmod) 참고)

```bash
$ root@8e979da535b5:/# chmod +x train.sh inference.sh
```

* 그리고 컨테이너를 빠져나온 다음(`CTRL+P, CTRL+Q`), 컨테이너를 커밋해서 새로운 이미지를 생성해보자.

```bash
~$ PS D:\Docker\HeLP> docker commit 8e97 test:0.2
sha256:f82ec64fff8b57493401e31fc9954ffc4251e8a97704b764ca79b7f8a2ba970f
~$ PS D:\Docker\HeLP> docker images
REPOSITORY                 TAG                    IMAGE ID            CREATED             SIZE
test                       0.2                    f82ec64fff8b        4 seconds ago       1.48GB
test                       0.1                    8337e8b1f269        2 hours ago         1.44GB
ubuntu                     16.04                  7e87e2b3bf7a        9 days ago          117MB
tensorflow/tensorflow      1.12.0-devel-gpu-py3   d6c139d2fdbf        2 months ago        3.77GB
docker4w/nsenter-dockerd   latest                 2f1c802f322f        3 months ago        187kB
```

* 이제 이 이미지를 `tar.gz` 로 만들어보자.

```bash
$ PS D:\Docker\HeLP> docker save test:0.2 | gzip > test-image.tar.gz
gzip : 'gzip' 용어가 cmdlet, 함수, 스크립트 파일 또는 실행할 수 있는 프로그램 이름으로 인식되지 않습니다. 이름이 정확한지 확인하고 경로가 포함된 경우 경로가 올바른지
 검증한 다음 다시 시도하십시오.
위치 줄:1 문자:24
+ docker save test:0.2 | gzip > test-image.tar.gz
+                        ~~~~
    + CategoryInfo          : ObjectNotFound: (gzip:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException
```

* 갓태우님의 자료 덕분에 금방 문제를 찾았다. [[링크](https://stackoverflow.com/questions/36733176/how-do-i-add-a-gzip-command-to-windows-cmd/36733177)]

* `cygwin` 설치 후 `Powershell` 말고 `cmd`를 통해서 압축하자.

```bash
$ D:\Docker\HeLP>docker save test:0.2 | gzip > test-image.tar.gz
```

* 압축 성공! 이제 카브에 올려보자. [[링크](https://help-khidi.kakaobrain.com/contests/117)]





---

### 추가 도움이 될 만한 것들

1. 도커 명령어
   * `run -i -t` 로 실행했다면 exit를 통해 나올 수 있는데, 이때 컨테이너는 종료된다.
   * 다시 들어가고 싶을 때는 `docker restart <컨테이너 이름>`으로 실행하고, `docker attach <컨테이너 이름>`으로 bash에 들어갈 수 있다.
   * `exit`대신에 `ctrl + p , ctrl + q` 로 하면 더 간편하다.