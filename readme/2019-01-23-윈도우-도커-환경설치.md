---
layout: post
title: "도커의 모든 것 : 윈도우10 프로"

---







# 0. windows 10 pro에 Docker 환경설정하기





- CPU- 가상환경 사용 설정  (작업관리자 > 성능 > 가상화 : 사용이 되어야함)

아래 링크타고 UEFI 펌웨어 설정 들어가면 자동 재부팅됨. 그때 나는 cpu configuration에서 virtualizatino Technology가 있었음. 거기 Enabled 로 체크하고 F10 눌러서 저장하고 나오기

https://support.bluestacks.com/hc/ko/articles/115003910391-%EB%82%B4-PC%EC%97%90%EC%84%9C-%EA%B0%80%EC%83%81%ED%99%94-VT-%EB%A5%BC-%ED%99%9C%EC%84%B1%ED%99%94%ED%95%98%EB%A0%A4%EB%A9%B4-%EC%96%B4%EB%96%BB%EA%B2%8C%ED%95%A9%EB%8B%88%EA%B9%8C-



- 참고 링크 : https://steemit.com/kr/@mystarlight/docker
- 윈도우 10 프로 이상은 다음링크로 다운로드(541MB) : https://hub.docker.com/editions/community/docker-ce-desktop-windows (로그인 해야함)
- 실행파일 클릭 전 Hyper-V 설치 : 제어판 > 프로그램 > Windows 기능 켜기/끄기 > Hyper-V 클릭하고 확인 > 재부팅
- Docker for Windows Installer.exe 실행해서 클릭 (완료되면 logout 버튼 클릭, 로그아웃되고 다시 로그인)
- GUI- Kitematic 부분은 : https://blog.hanumoka.net/2018/04/28/docker-20180428-windows10pro-install-docker/ 참고





# 1. Docker 기본 명령어

Windows power shell 또는 cmd 에서 docker 를 붙여서 입력하면된다

docker 치면 명령어들 쭉 나옴

- pull : 도커 이미지 다운로드
- images: 도커 이미지 list 보기
- run: 도커 적재 (stop id 하면 ps stop)
- ps: 도커 프로세스 상태 확인
- attach: 정지된 도커 프로세스 탑제
- logs: 도커 프로세스의 로그 확인
- tag: 도커 이미지 변경
- commit: 도커 프로세스를 스냅샷 형태로 이미지로 저장



##  명령어 실습



- docker login을 먼저 한다 username( not ID), PW 입력하면 Login Succeeded

- docker pull busybox

- docker run -it busybox sh (busy box 이미지 안에 들어온거)

- exit 하면 detach되서 docker ps. process 없음 ( docker ps -a 모든 프로세스 돌아갔던것까지 보여줌)

- 다시 실행

- docker start 0fd(container ID 앞부분) 하면 다시 pr 실행됨 

- docker attach 0fd (그 프로세스 다시 attach하면서 들어감)

- history (busybox에서 내가 실행했던 명령어 lis)

-  ctl + p, ctl+q will be  suspend mode

- img 그대로 있음

- docker commit 0fd(컨테이너아이디 앞부분) test(이미지 이름):0.1(tag부분)

- docker images 보면 test 가 만들어진걸 볼 수 있다.  

- docker tag test:0.1 test:latest

- commit 부분은 기존 이미지에 조금 작업해서 새로운 이미지 만들어 테스트할때.


# 2. Docker 기본 명령어



- login : 도커 이미지 Push를 위해 저장소에 로그인
- push: 도커 저장소(registry)에 image upload

> https://stackoverflow.com/questions/41984399/denied-requested-access-to-the-resource-is-denied-docker
>
>

- rmi: 시스템에 저장된 도커 이미지 삭제 , images id로 (rm) 

>  docker stop $(docker ps -a -q)
>
>  docker rm $(docker ps -a -q)
>
> 구동중인 모든 컨테이너들을 중지시키고 삭제
>
> 그리고 도커 이미지 삭제
>
>   docker rmi $(docker images -q) -> 원하는 이미지

- save: 도커 이미지를 파일로 저장
- load: 파일로 저장된 도커 이미지 시스템에 저장
- prune: 도커 데몬이 사용하는 시스템 purge
- cp: Container 내부의 파일을 Host로 복사



## 실습

- https://asciinema.org/a/165980 (오 이거 좋네)

- docker save specia1tw/test > ./test.tgz 

- docker save, load 할 때 https://forums.docker.com/t/invalid-tar-header-on-docker-load/22256/2>

- > docker save image -o tmp.tar
  > docker load -i tmp.tar

- save는 망분리 환경. 다 검증이 된 이미지를 save 해서 파일단위로 delivery하고 docker를 관리해서 배포할 수 있는경우. 혹은 contest

- docker cp imgId:/필요한부분 저장할경로

- docker network prune ( network )

- docker volume prune



# 3. Docker Image 만들기

source :

- https://github.com/goody80/docker-compose_for_go_revel

- https://asciinema.org/a/166486



Dockerfile
 - FROM: Base이미지(OS이미지 등)로 사용할 Layer를 가져오는 단계
 - LABEL: Meta 정보를 입력하는 부분(빌드 자동화 등에 사용)
 - RUN: 설치/설정 등을 위한 실행 부분
 - ENV: 환경변수에 대한 선언
 - COPY: Local 디스크의 파일을 컨테이너 내부로 복사
 - ENTRYPOINT: 런타임시에 최종적으로 실행 되는 명령어
 - EXPOSE: Port를 외부로 mapping 하기 위한 정보
    Build
    Cached Image



> windows에는 vi, vim이 없어서  https://www.vim.org/download.php#pc 다운로드 (windows 용 vi 설치 참고: https://m.blog.naver.com/PostView.nhn?blogId=wldns8656&logNo=220745321135&proxyReferer=https%3A%2F%2Fwww.google.com%2F)



> sudo도 없어서 https://kamang-it.tistory.com/236, https://kamang-it.tistory.com/entry/Choco%EC%9C%88%EB%8F%84%EC%9A%B0%EC%97%90%EC%84%9C-sudo-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0 로 choco와 sudo패키지를 다운받았다.



이후에는 에러떠서 다르게 공부해야할 듯







# 4. Docker 기본

https://subicura.com/2017/01/19/docker-guide-for-beginners-2.html

https://futurecreator.github.io/2018/11/16/docker-container-basics/





# 5. youtube docker 강의



https://www.youtube.com/watch?v=oRAkObdutsg

https://www.youtube.com/watch?v=9tW0QSsrhwc : docs.docker.com/get-started 부분









# 6. 카브 Docker file 업로드 형식

- Dockerfile
- inference.sh
- src
  - inference.py
  - train.py
- train.sh

그냥 루트에다가 넣는게 낫겠네



```cmd
chmod +x train.sh inference.sh
docker build --tag your-image:0.0.1 .      
docker save your-image:0.0.1 | gzip > your-image.tar.gz

# 나는 아래와 같이 함.(윈도우는 아래와 같이 해야함)

docker save imagename:tag -o filename.tar.gz

```

- 'your-image' 는 원하시는 이름
- 서버에서 task 실행될 때, /data/train , /data/model , /data/output이 docker container로 mount
- 소스코드에서는 위 directory의 파일을 읽거나 /data/model, /data/output 에 model 및 결과 파일을 저장하도록 작성해주시면 됩니다.
- docker를 빌드하기 전에 (chmod +x train.sh inference.sh 를 실행해서 두 파일에 실행 permission을 주고 docker build하시면 됩니다.)d
- FROM tensorflow/tensorflow:latest-gpu 





- [문의] Task 당사용할 수 있는 물리적 저장공간 크기가 얼마인가요? 
  - task의 volume limit 은 따로 제한하고 있지 않습니다.
- CPU 4core, RAM 16G





> SECURITY WARNING: You are building a Docker image from Windows against a non-Windows Docker host. All files and directories added to build context will have '-rwxr-xr-x' permissions. It is recommended to double check and reset permissions for sensitive files and directories.



- 흠 예상가능한 에러는 뭐가 있을까.
- 윈도우에서 만든점? 아까 위의 warning? 
- build guide 대로 하지 않았다는점? - cygwin64 terminal로 이용해보자(: https://stackoverflow.com/questions/36733176/how-do-i-add-a-gzip-command-to-windows-cmd/36733177)
- pushing10% , creating 20% running 70% failed

> https://stackoverflow.com/questions/29045140/env-bash-r-no-such-file-or-directory



# 7. 카브에 Docker file upload



- 1차시도 : 그냥 from python:3.6에 train.py, inference.py 제대로 돌아가는지 확인하기 위해서 작업함. windows 쉘파일 작업할때 엔터가 `'\r'`이 추가로 들어감  `train.sh`, `inference.sh` 에  `'\r'`이 들어간 걸 하나씩 빼줬었음 -> 성공

- 2차시도 : ubuntu에 python3.6 깔아서 실행 : fail , no python 없데 -> python 3.6으로 바꿈

- 조금만 바꿔서 이미지 바꾸려면 어떡하지?

  >I0124 20:42:15.557621  3066 exec.cpp:162] Version: 1.5.1
  >
  >I0124 20:42:15.560173  3084 exec.cpp:236] Executor registered on agent 729e9e4b-da63-44c7-8bec-c4d09c3365b1-S190
  >
  >I0124 20:42:15.560993  3081 executor.cpp:121] Registered docker executor on csi-cluster-gpu23.dakao.io
  >
  >I0124 20:42:15.561118  3077 executor.cpp:161] Starting task goldenpass05@gmail.com<@>contest_task<@>ab05609d-de49-46ba-9586-02a5fe5b3870:3f839
  >
  >Traceback (most recent call last):
  >
  >  File "train.py", line 2, in <module>
  >
  >​    import openslide
  >
  >  File "/usr/local/lib/python3.6/dist-packages/openslide/__init__.py", line 29, in <module>
  >
  >​    from openslide import lowlevel
  >
  >  File "/usr/local/lib/python3.6/dist-packages/openslide/lowlevel.py", line 58, in <module>
  >
  >​    _lib = cdll.LoadLibrary('libopenslide.so.0')
  >
  >  File "/usr/lib/python3.6/ctypes/__init__.py", line 426, in LoadLibrary
  >
  >​    return self._dlltype(name)
  >
  >  File "/usr/lib/python3.6/ctypes/__init__.py", line 348, in __init__
  >
  >​    self._handle = _dlopen(self._name, mode)
  >
  >OSError: libopenslide.so.0: cannot open shared object file: No such file or directory
  >
  >I0124 20:42:17.462743  3077 executor.cpp:675] Container exited with status 0

- 윗부분은 RUN apt-get install openslide-tools 추가로 Docker file에 넣고 만듦
- https://github.com/Steven-N-Hart/openslide-docker/blob/master/Dockerfile : openslide ubuntu에 설치
- num_tumor = num_tissues - num_non_tumor
- df 경고는 무시해도 됨 :; http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy

> I0124 23:55:08.143704  4474 exec.cpp:162] Version: 1.5.1
>
> I0124 23:55:08.146152  4477 exec.cpp:236] Executor registered on agent 729e9e4b-da63-44c7-8bec-c4d09c3365b1-S406
>
> I0124 23:55:08.146966  4481 executor.cpp:121] Registered docker executor on csi-cluster-gpu12.dakao.io
>
> I0124 23:55:08.147114  4482 executor.cpp:161] Starting task goldenpass05@gmail.com<@>contest_task<@>1eb1cc16-f144-4f6a-b3b3-f69756d5e137:d68ab
>
> Traceback (most recent call last):
>
>   File "train.py", line 155, in <module>
>
> ​    a = slide_data_analysis()
>
>   File "train.py", line 131, in slide_data_analysis
>
> ​    print(i,'\ubc88\uc9f8 \uc791\uc5c5 \uc911','\n')
>
> UnicodeEncodeError: 'ascii' codec can't encode characters in position 0-1: ordinal not in range(128)
>
> I0124 23:55:12.152091  4480 executor.cpp:675] Container exited with status 0

- 한글 안찍혀서 나는 에러

> I0125 00:32:31.795143 22974 exec.cpp:162] Version: 1.5.1
>
> I0125 00:32:31.797698 22980 exec.cpp:236] Executor registered on agent 729e9e4b-da63-44c7-8bec-c4d09c3365b1-S406
>
> I0125 00:32:31.798619 22978 executor.cpp:121] Registered docker executor on csi-cluster-gpu12.dakao.io
>
> I0125 00:32:31.798763 22981 executor.cpp:161] Starting task goldenpass05@gmail.com<@>contest_task<@>c3eec032-198a-437f-b3e3-f491e0aa952d:9e0df
>
> train.py:93: SettingWithCopyWarning: 
>
> A value is trying to be set on a copy of a slice from a DataFrame.
>
> Try using .loc[row_indexer,col_indexer] = value instead
>
> See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
>
> samples['tile_loc'] = list(samples.index)
>
> Traceback (most recent call last):
>
> File "train.py", line 155, in <module>
>
> ​    a = slide_data_analysis()
>
> File "train.py", line 139, in slide_data_analysis
>
> ​    num_non_tumor = int(num_non_tumor)
>
> File "/usr/local/lib/python3.6/dist-packages/pandas/core/series.py", line 118, in wrapper
>
> ​    "{0}".format(str(converter)))
>
> TypeError: cannot convert the series to <class 'int'>
>
> I0125 00:33:36.717439 22979 executor.cpp:675] Container exited with status 0
>
> W0125 00:33:36.717439 22974 logging.cpp:93] RAW: Received signal SIGTERM from process 35087 of user 0; exiting
>

- 이거는 train file compile error인데  python으로 옮기다가 잘못 옮김...



- 일단 기본적으로 image 빌드하는데 시간이 너무 오래 걸림. 기존의 빌드했던 부분에서 python 파일만 바꾸는 방법은 있을텐데 찾아봐야겠다.

- ```powershell
  docker image rm $(docker image ls --filter=dangling=true -q)
  
  # 이거랑 똑같은게 최근에 나온 prune
  docker image prune
  
  ```



- https://stackoverflow.com/questions/30853247/how-do-i-edit-a-file-after-i-shell-to-a-docker-container : 이걸로 이용해 봐야겠군.(succeeded)
- 이미지 조금 수정했을때는 처음부터 빌드하지 말고 commit을 이용하자 
  - 새로운 이미지 run 으로 들어가서 > 
  - 수정할거 수정하고 (sh 이나 py 같은 파일 수정시 반드시 :wq 하고 나와야겠지) > 
  - ctrl + p , ctrl + q로 나오고 > 
  - docker ps 보고 
  - container에서 최신작업한거 commit 하면 끝.
- https://stackoverflow.com/questions/30853247/how-do-i-edit-a-file-after-i-shell-to-a-docker-container









# 8. windows 10 pro : docker 저장경로 바꾸기

중간에 도커 저장소가 딸려서 외장하드로 옮겨야겠다는 생각이 듦

https://kiros33.blog.me/220351298695 mac이라서 패스 (pass)

도커 데스크탑 icon 우클릭해서 settings > advanced 에 있네 적용이 늦으니까 조금 (failed) 

https://github.com/docker/for-win/issues/1589 : **nategraf** comments 참고 (failed)

https://stackoverflow.com/questions/40465979/change-docker-native-images-location-on-windows-10-pro : 이대로 해보자 (succeeded!)

- Hyper-V 매니저 들어가서
- 오른쪽 바에 Hyper-V 설정 , D드라이브로 설정하고
- 실행시키고나서도 오른쪽 MobyLinuxVM 설정에 스마트 페이징 경로도 D 드라이브로 바꿔줌
- 다시 시작 시켜줘야함





# 9. 기타 에러



- ubuntu upgrade 안 될때

> ```
> Err:1 http://archive.ubuntu.com/ubuntu xenial InRelease
> Temporary failure resolving 'archive.ubuntu.com'
> Err:2 http://security.ubuntu.com/ubuntu xenial-security InRelease
> Temporary failure resolving 'security.ubuntu.com'
> Err:3 http://archive.ubuntu.com/ubuntu xenial-updates InRelease
> Temporary failure resolving 'archive.ubuntu.com'
> ```
>
> 이 경우 kr DNS 못찾는다는 건데 다시 로그인해도 안되길래 컴터 재시작 해줬음. 아마 VM 저장경로 바꿔줬는데 재시작을 안해서 뭔가 꼬인것일까? 뭐 이런 저런 이유에서 설정이 꼬였나봄.
